<div
  class="max-w-4xl mx-auto mt-6 bg-white rounded-2xl shadow-md border overflow-hidden"
>
  <div class="bg-blue-600 text-white py-3 px-6 text-lg font-semibold">
    {{ title }}
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6 grid gap-8">
    <div class="flex flex-col items-center gap-4">
      <!-- ... (Tu código de carga de imagen es genial, no lo tocamos) ... -->
      <div
        class="relative group w-52 h-52 rounded-xl overflow-hidden border border-gray-200 bg-gray-50 shadow-sm flex items-center justify-center cursor-pointer hover:shadow-md transition-all"
      >
        <img
          *ngIf="selectedImageUrl; else uploadPlaceholder"
          [src]="selectedImageUrl"
          alt="Vista previa"
          class="object-cover w-full h-full group-hover:opacity-80 transition-all"
        />
        <ng-template #uploadPlaceholder>
          <div class="flex flex-col items-center text-gray-400">
            <i class="pi pi-image text-3xl mb-1"></i>
            <span class="text-sm text-center">Sube una imagen</span>
          </div>
        </ng-template>
        <div
          *ngIf="selectedImageUrl"
          class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition-all"
        >
          <button
            type="button"
            pButton
            icon="pi pi-refresh"
            class="!bg-blue-500 hover:!bg-blue-600 !text-white !p-2 rounded-full shadow"
            (click)="triggerFileInput()"
          ></button>
          <button
            type="button"
            pButton
            icon="pi pi-times"
            class="!bg-red-500 hover:!bg-red-600 !text-white !p-2 rounded-full shadow"
            (click)="onRemoveImage()"
          ></button>
        </div>
      </div>
      <div *ngIf="uploadProgress > 0 && uploadProgress < 100" class="w-52 mt-2">
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div
            class="bg-blue-600 h-2 rounded-full"
            [style.width.%]="uploadProgress"
          ></div>
        </div>
        <p class="text-xs text-gray-500 text-center mt-1">
          Subiendo... {{ uploadProgress }}%
        </p>
      </div>
      <input
        #fileInput
        type="file"
        accept="image/*"
        (change)="onImageUpload($event)"
        hidden
      />
      <p-button
        *ngIf="!selectedImageUrl"
        icon="pi pi-upload"
        label="Subir imagen"
        class="!bg-blue-600 hover:!bg-blue-700 !text-white"
        (click)="triggerFileInput()"
        type="button"
      ></p-button>
    </div>

    <fieldset
      class="flex items-center justify-center gap-4 p-4 bg-gray-50 rounded-lg border"
    >
      <legend class="text-sm font-semibold text-gray-600 px-2">
        Tipo de Producto
      </legend>
      <label for="isCombo" class="font-semibold text-lg text-gray-700">
        ¿Es un Combo?
      </label>
      <p-inputSwitch id="isCombo" formControlName="isCombo"></p-inputSwitch>
      <span class="text-gray-500 text-sm">
        (Marcar si es un paquete de otros productos)
      </span>
    </fieldset>

    <!-- 3. DETALLES BÁSICOS DEL PRODUCTO (Sin cambios) -->
    <fieldset class="border rounded-lg p-4">
      <legend class="text-sm font-semibold text-gray-600 px-2">
        Detalles Básicos
      </legend>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1"
            >Nombre *</label
          >
          <input
            pInputText
            formControlName="name"
            placeholder="Ej. Lomo Saltado"
            class="w-full"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1"
            >Categoría *</label
          >
          <p-dropdown
            [options]="categories"
            optionLabel="name"
            optionValue="id"
            formControlName="categoryId"
            placeholder="Seleccionar categoría"
            [showClear]="true"
            class="w-full"
            styleClass="w-full"
          ></p-dropdown>
        </div>
      </div>

      <div class="mt-6">
        <label class="block text-sm font-semibold text-gray-700 mb-1"
          >Descripción</label
        >
        <textarea
          pTextarea
          formControlName="description"
          rows="3"
          placeholder="Breve descripción del producto"
          class="w-full"
        ></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1"
            >Precio (S/.) *</label
          >
          <p-inputNumber
            formControlName="price"
            mode="currency"
            currency="PEN"
            locale="es-PE"
            class="w-full"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1"
            >Tiempo de preparación (min) *</label
          >
          <p-inputNumber
            formControlName="preparationTimeMinutes"
            [min]="1"
            [showButtons]="true"
            suffix=" min"
            class="w-full"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">
            Estado
          </label>
          <p-dropdown
            [options]="[
              { label: 'Activo', value: true },
              { label: 'Inactivo', value: false }
            ]"
            formControlName="active"
            class="w-full"
            styleClass="w-full"
          ></p-dropdown>
        </div>
      </div>
    </fieldset>

    <!-- 
      4. SECCIONES DINÁMICAS (Ingredientes o Combos) 
      Usamos [hidden] para mantener el FormArray en el DOM y evitar errores.
    -->

    <!-- SECCIÓN DE INGREDIENTES (Producto Simple) -->
    <fieldset
      class="border rounded-lg p-4 animate-fade-in"
      [hidden]="isCombo"
      formArrayName="ingredients"
    >
      <legend class="text-sm font-semibold text-gray-600 px-2">
        Ingredientes (Producto Simple)
      </legend>
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-800">Lista de Ingredientes</h3>
        <p-button
          icon="pi pi-plus"
          label="Agregar Ingrediente"
          size="small"
          class="!bg-green-600 hover:!bg-green-700 !text-white"
          (click)="addIngredient()"
          type="button"
        ></p-button>
      </div>

      <div
        class="grid grid-cols-[1fr,auto,auto,auto] gap-3 text-sm font-semibold text-gray-600 mb-2 px-2"
      >
        <div>Ingrediente</div>
        <div>Cantidad</div>
        <div>Unidad</div>
        <div></div>
      </div>

      <div
        *ngFor="let ing of ingredients.controls; let i = index"
        [formGroupName]="i"
        class="border border-gray-200 p-3 rounded-lg mb-3 grid grid-cols-1 md:grid-cols-[1fr,auto,auto,auto] gap-3 items-center"
      >
        <!-- CAMBIADO A p-dropdown para consistencia y filtro -->
        <p-dropdown
          [options]="ingredientsList"
          optionLabel="name"
          optionValue="id"
          placeholder="Seleccionar ingrediente"
          formControlName="ingredientId"
          (onChange)="onIngredientSelect($event, i)"
          class="w-full"
          styleClass="w-full"
          [filter]="true"
          filterBy="name"
        ></p-dropdown>

        <p-inputNumber
          formControlName="quantity"
          [min]="0.1"
          [showButtons]="true"
          class="w-full"
          styleClass="w-full"
        ></p-inputNumber>

        <input
          pInputText
          formControlName="unitName"
          placeholder="Unidad"
          readonly
          class="flex-1 bg-gray-100 text-gray-600"
        />

        <p-button
          type="button"
          icon="pi pi-trash"
          severity="danger"
          [text]="true"
          (click)="removeIngredient(i)"
        ></p-button>
      </div>
      <div
        *ngIf="ingredients.controls.length === 0"
        class="text-center text-gray-400 italic p-4"
      >
        Agrega ingredientes para este producto.
      </div>
    </fieldset>

    <!-- SECCIÓN DE ITEMS DEL COMBO (Combo) -->
    <fieldset
      class="border rounded-lg p-4 animate-fade-in"
      [hidden]="!isCombo"
      formArrayName="comboItems"
    >
      <legend class="text-sm font-semibold text-gray-600 px-2">
        Items del Combo (Paquete)
      </legend>
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-800">Productos Incluidos</h3>
        <p-button
          icon="pi pi-plus"
          label="Agregar Producto"
          size="small"
          class="!bg-purple-600 hover:!bg-purple-700 !text-white"
          (click)="addComboItem()"
          type="button"
        ></p-button>
      </div>

      <div
        class="grid grid-cols-[1fr,auto,auto] gap-3 text-sm font-semibold text-gray-600 mb-2 px-2"
      >
        <div>Producto</div>
        <div>Cantidad</div>
        <div>Acción</div>
      </div>

      <div
        *ngFor="let item of comboItems.controls; let i = index"
        [formGroupName]="i"
        class="border border-gray-200 p-3 rounded-lg mb-3 grid grid-cols-1 md:grid-cols-[1fr,auto,auto] gap-3 items-center"
      >
        <p-dropdown
          [options]="selectableProducts()"
          optionLabel="name"
          optionValue="id"
          placeholder="Seleccionar producto"
          formControlName="simpleProductId"
          [filter]="true"
          filterBy="name"
          class="w-full"
          styleClass="w-full"
        ></p-dropdown>

        <p-inputNumber
          formControlName="quantity"
          [min]="1"
          [step]="1"
          [showButtons]="true"
          class="w-full"
          styleClass="w-full"
        ></p-inputNumber>

        <p-button
          type="button"
          icon="pi pi-trash"
          severity="danger"
          [text]="true"
          (click)="removeComboItem(i)"
        ></p-button>
      </div>
      <div
        *ngIf="comboItems.controls.length === 0"
        class="text-center text-gray-400 italic p-4"
      >
        Agrega productos para armar este combo.
      </div>
    </fieldset>

    <!-- 5. BOTONES DE ACCIÓN (Sin cambios) -->
    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
      <p-button
        type="button"
        label="Cancelar"
        class="p-button-secondary"
        (click)="onCancel()"
      ></p-button>
      <p-button
        type="submit"
        [label]="isEditMode ? 'Guardar Cambios' : 'Crear Producto'"
        icon="pi pi-save"
        class="p-button-primary"
        [loading]="loading"
        [disabled]="form.invalid"
      ></p-button>
    </div>
  </form>
</div>
