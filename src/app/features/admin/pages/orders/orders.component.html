<div class="p-6">
  <h2 class="text-2xl font-bold mb-4">üì¶ Gesti√≥n de √ìrdenes</h2>

  @if (orders.length === 0) {
  <div
    class="flex flex-col items-center justify-center bg-gray-50 border border-dashed border-gray-300 rounded-lg p-10 text-center shadow-sm"
  >
    <i class="pi pi-inbox text-6xl text-gray-400 mb-4"></i>
    <h3 class="text-lg font-semibold text-gray-700">
      No tienes √≥rdenes registradas
    </h3>
    <p class="text-gray-500 mt-1 mb-4">
      Cuando recibas nuevas √≥rdenes aparecer√°n aqu√≠.
    </p>
    <button
      pButton
      type="button"
      icon="pi pi-refresh"
      label="Actualizar"
      class="p-button-outlined p-button-sm"
      (click)="loadOrders()"
    ></button>
  </div>
  } @else {
  <div class="card p-4 bg-white shadow-xl rounded-2xl border border-gray-100">
    <p-table
      #dt
      [value]="orders"
      styleClass="p-datatable-gridlines p-datatable-sm p-datatable-hover"
      [tableStyle]="{ 'min-width': '60rem' }"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [globalFilterFields]="[
        'id',
        'customerName',
        'deliveryStreet',
        'statusName'
      ]"
    >
      <ng-template pTemplate="caption">
        <div
          class="flex flex-col sm:flex-row justify-between items-center gap-4 py-3 px-1 border-b border-gray-200"
        >
          <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <i class="pi pi-list text-primary-500"></i>
            √ìrdenes Recientes
          </h3>

          <div class="flex flex-col sm:flex-row items-center gap-2">
            <button
              pButton
              type="button"
              label="Nueva Venta (POS)"
              icon="pi pi-plus"
              class="p-button-success"
              (click)="goToPos()"
            ></button>
            <div class="p-input-icon-left w-full sm:w-64">
              <i class="pi pi-search text-gray-400"></i>
              <input
                pInputText
                type="text"
                (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                placeholder="Buscar orden..."
                class="w-full pl-8 py-2 border rounded-full focus:ring-2 focus:ring-primary-300 focus:border-primary-500 transition duration-200"
              />
            </div>
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr class="bg-gray-50 text-gray-600 font-semibold text-sm">
          <th pSortableColumn="id" class="!w-[5%] text-left p-3">ID</th>
          <th pSortableColumn="customerName" class="text-left p-3">Cliente</th>
          <th class="!w-[28%] text-left p-3">Entrega / Tipo</th>
          <th pSortableColumn="date" class="text-left p-3">Fecha</th>
          <th pSortableColumn="total" class="text-right p-3">Total</th>
          <th class="text-center !w-[12%] p-3">Estado</th>
          <th class="text-center !w-[10%] p-3">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-order>
        <tr class="hover:bg-gray-50 transition-colors duration-150">
          <td class="p-3">
            <span class="font-bold text-gray-700">#{{ order.id }}</span>
          </td>

          <td class="p-3">
            <div class="flex items-center gap-3">
              <p-avatar
                [label]="getInitials(order.customerName)"
                shape="circle"
                styleClass="bg-blue-100 text-blue-700 font-bold text-sm border-2 border-blue-200"
              ></p-avatar>
              <span class="font-medium text-gray-800">{{
                order.customerName
              }}</span>
            </div>
          </td>

          <td class="p-3">
            <div
              *ngIf="order.deliveryStreet; else noDelivery"
              class="flex items-center justify-between gap-2"
            >
              <div>
                <p
                  class="font-semibold text-gray-800 truncate max-w-[150px]"
                  [pTooltip]="order.deliveryStreet"
                >
                  {{ order.deliveryStreet }}
                </p>
                <p class="text-xs text-gray-500">
                  {{ order.deliveryReference || order.deliveryCity }}
                </p>
              </div>
              <p-button
                icon="pi pi-map-marker"
                [text]="true"
                [rounded]="true"
                severity="secondary"
                pTooltip="Ver mapa de entrega"
                (click)="op.toggle($event)"
                styleClass="!min-w-[auto]"
              ></p-button>
              <p-panel #op [style]="{ width: '320px' }">
                <div class="p-2">
                  <p class="font-semibold text-gray-800 mb-2">
                    Ubicaci√≥n de Entrega
                  </p>
                  <img
                    class="rounded-lg border border-gray-200 shadow-sm"
                    width="300"
                    height="200"
                    [src]="
                      'https://maps.googleapis.com/maps/api/staticmap?center=' +
                      order.deliveryLatitude +
                      ',' +
                      order.deliveryLongitude +
                      '&zoom=16&size=300x200&markers=color:red%7C' +
                      order.deliveryLatitude +
                      ',' +
                      order.deliveryLongitude +
                      '&key=' +
                      googleMapsApiKey
                    "
                    alt="Mapa de la ubicaci√≥n de entrega"
                  />
                  <p class="text-sm text-gray-700 mt-3">
                    {{ order.deliveryStreet }}, {{ order.deliveryCity }}
                  </p>
                  <p
                    *ngIf="order.deliveryReference"
                    class="text-xs text-gray-500"
                  >
                    Ref: {{ order.deliveryReference }}
                  </p>
                </div>
              </p-panel>
            </div>
            <ng-template #noDelivery>
              <p-tag
                [value]="order.typeName"
                icon="pi pi-building"
                severity="info"
                class="text-sm"
              ></p-tag>
            </ng-template>
          </td>

          <td class="p-3">
            <span class="text-gray-600 text-sm">{{
              order.date | date : "dd/MM/yy"
            }}</span
            ><br />
            <span class="text-gray-500 text-xs">{{
              order.date | date : "h:mm a"
            }}</span>
          </td>

          <td class="p-3 text-right">
            <span class="font-extrabold"
              >S/. {{ order.total | number : "1.2-2" }}</span
            >
          </td>

          <td class="p-3 text-center">
            <p-tag
              [value]="order.statusName"
              [severity]="getStatusSeverity(order.statusName)"
              [rounded]="true"
              class="text-xs font-semibold px-2 py-1"
            ></p-tag>
          </td>

          <td class="p-3 text-center">
            <p-button
              type="button"
              icon="pi pi-eye"
              size="small"
              pTooltip="Ver detalle"
              [rounded]="true"
              severity="info"
              (click)="viewOrderDetail(order.id)"
              class="mr-2"
            ></p-button>
            <p-button
              type="button"
              icon="pi pi-times"
              size="small"
              pTooltip="Cancelar orden"
              [rounded]="true"
              severity="danger"
              (click)="cancelOrder(order.id)"
              [disabled]="
                order.statusName === 'Completada' ||
                order.statusName === 'Cancelado'
              "
            ></p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-6 text-gray-500">
            No se encontraron √≥rdenes que coincidan con la b√∫squeda.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  }

  <div class="mt-10">
    <h3 class="text-xl font-semibold mb-6">üçΩÔ∏è Vista de Mesas</h3>

    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6"
    >
      <div
        *ngFor="let table of tables"
        class="p-6 rounded-xl shadow-md flex flex-col items-center justify-center cursor-pointer"
        [ngClass]="{
          'bg-green-100 border border-green-400': table.status === 'FREE',
          'bg-yellow-100 border border-yellow-400': table.status === 'OCCUPIED',
          'bg-red-100 border border-red-400': table.status === 'OUT_OF_SERVICE'
        }"
        (click)="openTableActions(table)"
      >
        <i class="pi pi-table text-3xl mb-2"></i>
        <span class="font-semibold">Mesa {{ table.code }}</span>
        <small class="text-gray-700">{{ getStatusLabel(table.status) }}</small>
      </div>

      <p-dialog
        header="Modificar Mesa"
        [modal]="true"
        [(visible)]="dialogTableVisible"
        [style]="{ width: '40rem', height: 'auto', 'max-height': '90vh' }"
        [contentStyle]="{ 'overflow-y': 'auto' }"
      >
        <span class="p-text-secondary block mb-6">
          Actualiza la informaci√≥n de la mesa seleccionada
        </span>

        <div class="flex flex-col space-y-4">
          <div class="flex flex-col gap-4 mb-4">
            <label for="name" class="font-semibold w-32">Codigo</label>
            <input
              pInputText
              id="name"
              class="flex-auto"
              [(ngModel)]="selectedTable.code"
              autocomplete="off"
            />
          </div>

          <div class="flex flex-col gap-4 mb-4">
            <label>Capacidad</label>
            <p-floatlabel>
              <p-inputnumber
                id="capacity"
                [showButtons]="true"
                buttonLayout="horizontal"
                spinnerMode="horizontal"
                class="w-full"
                [(ngModel)]="selectedTable.capacity"
              >
                <ng-template #incrementbuttonicon>
                  <span class="pi pi-plus"></span>
                </ng-template>
                <ng-template #decrementbuttonicon>
                  <span class="pi pi-minus"></span>
                </ng-template>
              </p-inputnumber>
            </p-floatlabel>
          </div>

          <div class="flex flex-col gap-4 mb-4">
            <label for="status" class="font-semibold w-32">Estado</label>
            <p-autocomplete
              id="status"
              [suggestions]="filteredStatusOptions"
              [(ngModel)]="selectedStatusOption"
              (completeMethod)="searchTableState($event)"
              [dropdown]="true"
              appendTo="body"
              [optionLabel]="'label'"
              styleClass="w-full"
              (onSelect)="onStatusSelect($event)"
            >
              <ng-template let-option pTemplate="item">
                <div class="flex items-center gap-2">
                  <span
                    class="w-3 h-3 rounded-full"
                    [ngClass]="{
                      'bg-green-500': option.value === 'FREE',
                      'bg-yellow-500': option.value === 'OCCUPIED',
                      'bg-red-500': option.value === 'OUT_OF_SERVICE'
                    }"
                  ></span>
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
            </p-autocomplete>
          </div>

          <div class="flex justify-end gap-2">
            <p-button
              label="Cancelar"
              severity="secondary"
              (click)="dialogTableVisible = false"
            />
            <p-button label="Guardar" (click)="saveTable()" />
          </div>
        </div>
      </p-dialog>
    </div>
  </div>
</div>
