<div class="p-6">
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <!-- 1. Cabecera -->
    <div class="p-6 border-b flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Gestionar Promociones</h2>
        <p class="text-gray-500">
          Crea, edita y gestiona descuentos, ofertas y promociones.
        </p>
      </div>
      <p-button
        label="Nueva Promoción"
        icon="pi pi-plus"
        (onClick)="openNewModal()"
      ></p-button>
    </div>

    <p-table
      [value]="promotions()"
      [loading]="isLoading()"
      [paginator]="true"
      [rows]="10"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-striped"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="name">Nombre <p-sortIcon field="name"></p-sortIcon></th>
          <th pSortableColumn="active">Estado <p-sortIcon field="active"></p-sortIcon></th>
          <th pSortableColumn="discountType">Tipo <p-sortIcon field="discountType"></p-sortIcon></th>
          <th pSortableColumn="discountValue">Valor <p-sortIcon field="discountValue"></p-sortIcon></th>
          <th pSortableColumn="startDate">Inicia <p-sortIcon field="startDate"></p-sortIcon></th>
          <th pSortableColumn="endDate">Termina <p-sortIcon field="endDate"></p-sortIcon></th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-promo>
        <tr>
          <td class="font-semibold">{{ promo.name }}</td>
          <td>
            <p-tag
              [severity]="promo.active ? 'success' : 'danger'"
              [value]="promo.active ? 'Activa' : 'Inactiva'"
            ></p-tag>
          </td>
          <td>
            {{ promo.discountType === 'PERCENTAGE' ? 'Porcentaje' : 'Monto Fijo' }}
          </td>
          <td>
            <span class="font-bold">
              {{ promo.discountType === 'PERCENTAGE' ? (promo.discountValue | number:'1.0-0') + '%' : (promo.discountValue | currency:'S/ ') }}
            </span>
          </td>
          <td>{{ promo.startDate | date : 'dd/MM/yy, h:mm a' }}</td>
          <td>{{ promo.endDate | date : 'dd/MM/yy, h:mm a' }}</td>
          <td>
            <div class="flex gap-2">
              <p-button
                icon="pi pi-pencil"
                styleClass="p-button-text"
                pTooltip="Editar"
                (onClick)="openEditModal(promo)"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-text p-button-danger"
                pTooltip="Eliminar"
                (onClick)="onDelete(promo, $event)"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-4">
            No se encontraron promociones.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-dialog
  [header]="isEditMode() ? 'Editar Promoción' : 'Nueva Promoción'"
  [(visible)]="displayModal"
  [modal]="true"
  [style]="{ width: '600px' }"
  (onHide)="hideModal()"
>
  <form [formGroup]="promotionForm" (ngSubmit)="onSave()">
    <div class="flex flex-col gap-4 p-fluid pt-4">
      
      <div class="flex flex-col">
        <label for="name" class="font-semibold mb-1">Nombre</label>
        <input pInputText id="name" formControlName="name" />
      </div>
      
      <div class="flex flex-col">
        <label for="description" class="font-semibold mb-1">Descripción</label>
        <textarea
          pTextarea
          id="description"
          formControlName="description"
          rows="3"
        ></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="flex flex-col">
          <label for="startDate" class="font-semibold mb-1">Fecha de Inicio</label>
          <p-calendar
            id="startDate"
            formControlName="startDate"
            [showTime]="true"
            hourFormat="12"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
          ></p-calendar>
        </div>
        <div class="flex flex-col">
          <label for="endDate" class="font-semibold mb-1">Fecha de Fin</label>
          <p-calendar
            id="endDate"
            formControlName="endDate"
            [showTime]="true"
            hourFormat="12"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
          ></p-calendar>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="flex flex-col">
          <label for="discountType" class="font-semibold mb-1">Tipo de Descuento</label>
          <p-dropdown
            id="discountType"
            formControlName="discountType"
            [options]="discountTypes"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccione un tipo"
          ></p-dropdown>
        </div>
        <div class="flex flex-col">
          <label for="discountValue" class="font-semibold mb-1">Valor</label>
          <p-inputNumber
            id="discountValue"
            formControlName="discountValue"
            [min]="0.01"
            [prefix]="promotionForm.get('discountType')?.value === 'FIXED_AMOUNT' ? 'S/ ' : ''"
            [suffix]="promotionForm.get('discountType')?.value === 'PERCENTAGE' ? ' %' : ''"
          ></p-inputNumber>
        </div>
      </div>

      <div class="flex flex-col">
        <label for="products" class="font-semibold mb-1">Aplicar a Productos (Opcional)</label>
        <p-multiSelect
          id="products"
          formControlName="applicableProducts"
          [options]="products()"
          optionLabel="name"
          placeholder="Seleccione productos"
          [showClear]="true"
          appendTo="body"
        ></p-multiSelect>
      </div>

      <div class="flex flex-col">
        <label for="categories" class="font-semibold mb-1">Aplicar a Categorías (Opcional)</label>
        <p-multiSelect
          id="categories"
          formControlName="applicableCategories"
          [options]="categories()"
          optionLabel="name"
          placeholder="Seleccione categorías"
          [showClear]="true"
          appendTo="body"
        ></p-multiSelect>
      </div>
      
      <div class="flex items-center justify-between">
        <label for="active" class="font-semibold">Promoción Activa</label>
        <p-inputSwitch id="active" formControlName="active"></p-inputSwitch>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      (onClick)="hideModal()"
      styleClass="p-button-text"
    ></p-button>
    <p-button
      label="Guardar Promoción"
      icon="pi pi-check"
      (click)="onSave()"
      [loading]="isSubmitting()"
      [disabled]="promotionForm.invalid"
    ></p-button>
  </ng-template>
</p-dialog>