<div class="max-w-4xl mx-auto p-6 space-y-8">
  <div class="flex justify-between items-center mb-4">
    <button
      pButton
      label="Volver"
      icon="pi pi-arrow-left"
      class="p-button-text"
      type="button"
      (click)="backToStaff()"
    ></button>
  </div>
  
  <section
    class="user-info p-6 rounded-2xl shadow-md flex flex-col md:flex-row md:items-center gap-6"
  >
    <div class="flex-shrink-0">
      <img
        [src]="employee?.profileImageUrl || 'default-avatar.jpg'"
        alt="Imagen de perfil"
        class="w-28 h-28 rounded-full border-2 border-gray-300 object-cover"
      />
    </div>
    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label>Nombre completo</label
        ><input
          pInputText
          type="text"
          [value]="employee?.fullName"
          readonly
          disabled
          class="w-full bg-gray-100 cursor-not-allowed"
        />
      </div>
      <div>
        <label>Nombre de usuario</label
        ><input
          pInputText
          type="text"
          [value]="employee?.username"
          readonly
          disabled
          class="w-full bg-gray-100 cursor-not-allowed"
        />
      </div>
      <div>
        <label>Correo electrónico</label
        ><input
          pInputText
          type="text"
          [value]="employee?.email"
          readonly
          disabled
          class="w-full bg-gray-100 cursor-not-allowed"
        />
      </div>
    </div>
  </section>

  <section class="employee-form p-6 rounded-2xl shadow-md">
    <ng-container *ngIf="!loading; else loadingTpl">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">
        {{ isEditMode ? 'Editar' : 'Crear' }} Empleado
      </h2>
      <form
        [formGroup]="employeeForm"
        (ngSubmit)="onSubmit()"
        class="space-y-6"
      >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label>Nombre</label>
            <input
              pInputText
              type="text"
              formControlName="firstName"
              class="w-full"
            />
            <small
              class="text-red-500"
              *ngIf="
                employeeForm.get('firstName')?.invalid &&
                employeeForm.get('firstName')?.touched
              "
            >
              El nombre es obligatorio
            </small>
          </div>

          <div>
            <label>Apellidos</label>
            <input
              pInputText
              type="text"
              formControlName="lastName"
              class="w-full"
            />
            <small
              class="text-red-500"
              *ngIf="
                employeeForm.get('lastName')?.invalid &&
                employeeForm.get('lastName')?.touched
              "
            >
              El apellido es obligatorio
            </small>
          </div>

          <div>
            <label>Nombre de Usuario</label>
            <input
              pInputText
              type="text"
              formControlName="username"
              class="w-full"
            />
            <small
              class="text-red-500"
              *ngIf="
                employeeForm.get('username')?.invalid &&
                employeeForm.get('username')?.touched
              "
            >
              <span *ngIf="employeeForm.get('username')?.errors?.['required']">
                El nombre de usuario es obligatorio.
              </span>
              <span *ngIf="employeeForm.get('username')?.errors?.['minlength']">
                Debe tener al menos 3 caracteres.
              </span>
            </small>
          </div>

          <div>
            <label>Correo Electrónico</label>
            <input
              pInputText
              type="email"
              formControlName="email"
              class="w-full"
            />
            <small
              class="text-red-500"
              *ngIf="
                employeeForm.get('email')?.invalid &&
                employeeForm.get('email')?.touched
              "
            >
              <span *ngIf="employeeForm.get('email')?.errors?.['required']">
                El correo es obligatorio.
              </span>
              <span *ngIf="employeeForm.get('email')?.errors?.['email']">
                El correo no es válido.
              </span>
            </small>
          </div>

          <div>
            <label>Teléfono (Opcional)</label>
            <input
              pInputText
              type="text"
              formControlName="phone"
              class="w-full"
            />
          </div>

          <div *ngIf="!isEditMode">
            <label>Contraseña</label>
            <input
              pInputText
              type="password"
              formControlName="password"
              class="w-full"
              placeholder="Contraseña inicial"
            />
            <small
              class="text-red-500"
              *ngIf="
                employeeForm.get('password')?.invalid &&
                employeeForm.get('password')?.touched
              "
            >
              <span *ngIf="employeeForm.get('password')?.errors?.['required']">
                La contraseña es obligatoria.
              </span>
              <span *ngIf="employeeForm.get('password')?.errors?.['minlength']">
                Debe tener al menos 8 caracteres.
              </span>
            </small>
          </div>

          <div>
            <label>Cargo</label>
            <p-dropdown
              [options]="positions"
              optionLabel="name"
              optionValue="id"
              formControlName="positionId"
              placeholder="Seleccione un cargo"
              class="w-full"
            >
              <ng-template let-pos pTemplate="selectedItem">
                <div class="font-semibold" *ngIf="pos">
                  {{ pos.name | positionLabel }}
                </div>
              </ng-template>
              <ng-template let-pos pTemplate="item">
                <div>
                  <div class="font-semibold">{{ pos.name | positionLabel }}</div>
                  <div class="text-xs text-gray-500">
                    {{ pos.description }}
                  </div>
                </div>
              </ng-template>
            </p-dropdown>
            <small
              class="text-red-500"
              *ngIf="
                employeeForm.get('positionId')?.invalid &&
                employeeForm.get('positionId')?.touched
              "
              >Campo obligatorio</small
            >
          </div>

          <div>
            <label>Sueldo</label>
            <p-inputNumber
              inputId="salary"
              formControlName="salary"
              mode="currency"
              currency="PEN"
              locale="es-PE"
              currencyDisplay="symbol"
              class="w-full"
            />
          </div>

          <div>
            <label>Fecha de contratación</label>
            <p-datepicker
              formControlName="hireDate"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
              class="w-full"
              styleClass="w-full"
            ></p-datepicker>
          </div>

          <div>
            <label>Estado</label>
            <p-dropdown
              [options]="employmentStatuses"
              formControlName="status"
              optionLabel="label"
              optionValue="value"
              class="w-full"
            ></p-dropdown>
          </div>
        </div>

        <div class="flex justify-end gap-4 mt-6">
          <button
            pButton
            label="Cancelar"
            class="p-button-text"
            type="button"
            (click)="backToStaff()"
          ></button>
          <button
            pButton
            [label]="isEditMode ? 'Guardar Cambios' : 'Crear Empleado'"
            icon="pi pi-save"
            type="submit"
            [loading]="saving"
          ></button>
        </div>
      </form>
    </ng-container>

    <ng-template #loadingTpl>
      <div class="text-center py-10 text-gray-500">Cargando datos...</div>
    </ng-template>
  </section>

  <section *ngIf="isEditMode" class="mt-5 bg-white p-6 rounded-2xl shadow-md">
    
    <div class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-semibold text-gray-800">
         Horarios del Empleado
       </h3>
       <button 
        pButton
        label="Agregar Horario"
        icon="pi pi-plus"
        class="p-button-sm"
        (click)="openScheduleDialog()">
      </button>
    </div>

    <p-table
      [value]="schedules"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 20]"
      responsiveLayout="scroll"
      styleClass="p-datatable-striped p-datatable-sm"
      [loading]="loading && isEditMode"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      emptyMessage="No hay horarios registrados para este empleado."
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Día</th>
          <th>Hora inicio</th>
          <th>Hora fin</th>
          <th style="width: 120px; text-align: center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-schedule>
        <tr>
          <td>{{ schedule.dayOfWeek | dayOfWeekName }}</td>
          <td>{{ schedule.startTime | slice:0:5 }}</td> <td>{{ schedule.endTime | slice:0:5 }}</td>   <td class="text-center">
            <button
              pButton
              pTooltip="Editar horario"
              tooltipPosition="top"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm p-button-warning"
              (click)="openScheduleDialog(schedule)"
            ></button>

            <button
              pButton
              pTooltip="Eliminar horario"
              tooltipPosition="top"
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-sm p-button-danger"
              (click)="deleteSchedule(schedule.id)"
            ></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </section>

  <p-dialog
    header="{{ editingSchedule ? 'Editar Horario' : 'Agregar Horario' }}"
    [(visible)]="displayScheduleDialog"
    [modal]="true"
    [closable]="true" 
    (onHide)="editingSchedule = undefined" 
  >
    <form
      [formGroup]="scheduleForm"
      (ngSubmit)="saveSchedule()"
      class="space-y-4 p-2"
    >
      <div>
        <label for="dayOfWeek" class="font-semibold">Día de la semana</label>
        <p-dropdown
          inputId="dayOfWeek"
          [options]="daysOfWeek"
          formControlName="dayOfWeek"
          optionLabel="label"
          optionValue="value"
          class="w-full"
          styleClass="w-full"
          placeholder="Seleccione un día"
        ></p-dropdown>
      </div>
      
      <div class="flex flex-col">
        <label for="startTime" class="font-semibold">Hora inicio</label>
        <p-datepicker
          inputId="startTime"
          [timeOnly]="true"
          hourFormat="24"
          formControlName="startTime"
          class="w-full"
          styleClass="w-full"
          [showSeconds]="false"
          [showIcon]="true"
          appendTo="body"
        />
      </div>
      
      <div class="flex flex-col">
        <label for="endTime" class="font-semibold">Hora fin</label>
        <p-datepicker
          inputId="endTime"
          [timeOnly]="true"
          hourFormat="24"
          formControlName="endTime"
          class="w-full"
          styleClass="w-full"
          [showSeconds]="false"
          [showIcon]="true"
          appendTo="body"
        />
      </div>
      
      <div class="flex justify-end gap-2 mt-4">
        <button
          pButton
          type="button"
          label="Cancelar"
          class="p-button-text"
          (click)="displayScheduleDialog = false"
        ></button>
        <button
          pButton
          type="submit"
          label="Guardar"
          icon="pi pi-save"
          [disabled]="scheduleForm.invalid"
        ></button>
      </div>
    </form>
  </p-dialog>
</div>