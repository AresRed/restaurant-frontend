<div class="space-y-6">
  <div *ngIf="isDelivery()">
    <h3 class="font-semibold text-gray-700">
      Arrastra el marcador a tu ubicación de entrega:
    </h3>

    <div
      *ngIf="!mapReady"
      class="flex justify-center items-center h-64 border rounded-xl bg-gray-100"
    >
      <p-progressSpinner
        styleClass="w-16 h-16"
        strokeWidth="4"
      ></p-progressSpinner>
    </div>

    <div
      *ngIf="mapReady"
      #mapContainer
      id="map"
      class="w-full h-64 rounded-xl border mb-4"
    ></div>
    
    <div
      *ngIf="mapReady && !isMarkerInsideZone"
      class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-100 border border-red-200"
      role="alert"
    >
      <i class="pi pi-exclamation-triangle mr-2"></i>
      <span class="font-medium">¡Fuera de zona!</span> Lo sentimos, esta
      ubicación no está dentro de nuestra área de reparto.
    </div>

    <app-address-form
      *ngIf="mapReady"
      [initialData]="currentDeliveryAddress"
      (addressChange)="updateAddressFromForm($event)"
    >
    </app-address-form>
  </div>

  <div *ngIf="isDineIn()">
    <div class="text-center mb-6">
      <i class="pi pi-table text-5xl text-blue-500 mb-3"></i>
      <h3 class="text-xl font-bold text-gray-800">
        Selecciona una mesa disponible
      </h3>
      <p class="text-gray-500 mt-1">
        Elige la mesa en la que te encuentras para continuar.
      </p>
    </div>

    <div *ngIf="tablesLoading" class="flex justify-center items-center h-48">
      <p-progressSpinner></p-progressSpinner>
    </div>

    <div
      *ngIf="!tablesLoading && availableTables.length === 0"
      class="text-center p-6 bg-yellow-50 text-yellow-700 rounded-lg"
    >
      <p>Lo sentimos, parece que no hay mesas libres en este momento.</p>
    </div>

    <div
      *ngIf="!tablesLoading && availableTables.length > 0"
      class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"
    >
      <div
        *ngFor="let table of availableTables"
        class="p-4 rounded-xl border-2 flex flex-col items-center justify-center aspect-square cursor-pointer transition-all duration-200"
        (click)="selectTable(table)"
        [ngClass]="{
          'bg-blue-500 border-blue-700 text-white shadow-lg scale-105':
            selectedTable?.id === table.id,
          'bg-white border-gray-200 text-gray-700 hover:border-blue-400 hover:bg-blue-50':
            selectedTable?.id !== table.id
        }"
      >
        <i class="pi pi-table text-3xl mb-1"></i>
        <span class="font-bold text-lg">{{ table.code }}</span>
        <span class="text-xs">Cap: {{ table.capacity }}</span>
      </div>
    </div>
  </div>

  <div *ngIf="isTakeAway()">
    <p>Próximamente: selección de sucursal para recoger.</p>
  </div>

  <div class="flex justify-between mt-6">
    <p-button
      label="Volver"
      icon="pi pi-arrow-left"
      (click)="back.emit()"
    ></p-button>
    <p-button
      label="Siguiente"
      icon="pi pi-arrow-right"
      iconPos="right"
      (click)="onNext()"
      [disabled]="
        (isDelivery() &&
          (!currentDeliveryAddress.street || !isMarkerInsideZone)) ||
        (isDineIn() && !selectedTable)
      "
    ></p-button>
  </div>
</div>
