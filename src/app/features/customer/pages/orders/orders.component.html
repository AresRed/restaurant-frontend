<div class="min-h-screen">
  <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight text-slate-900">
        Tu Actividad
      </h1>
      <p class="mt-1 text-slate-500">
        Un resumen de todos tus pedidos en nuestro restaurante.
      </p>
    </header>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-20">
      <p-progressSpinner></p-progressSpinner>
    </div>

    <!-- Sin pedidos -->
    <div
      *ngIf="!loading && orders.length === 0"
      class="text-center py-16 bg-white rounded-2xl shadow-sm"
    >
      <h3 class="text-xl font-semibold">Aún no has hecho ningún pedido</h3>
      <p-button
        label="Descubrir el menú"
        styleClass="mt-6"
        routerLink="/menu"
      ></p-button>
    </div>

    <!-- Lista de pedidos -->
    <div *ngIf="!loading && orders.length > 0" class="space-y-8">
      <div
        *ngFor="let order of orders"
        class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300"
      >
        <!-- Header del pedido -->
        <header
          class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-5 border-b border-slate-200 gap-4"
        >
          <div>
            <p class="text-sm text-slate-500">
              Pedido del {{ order.date | date : "d MMMM, yyyy" : "" : "es-PE" }}
            </p>
            <p class="font-bold text-2xl text-slate-800">
              Total: S/{{ order.total | number : "1.2-2" }}
            </p>
          </div>
          <div class="flex items-center gap-2">
            <p-button
              label="Ver Recibo"
              icon="pi pi-receipt"
              [text]="true"
              (onClick)="viewOrderDetail(order.id)"
            ></p-button>
            <p-button
              label="Reordenar"
              icon="pi pi-replay"
              (onClick)="reorder(order.id)"
            ></p-button>
          </div>
        </header>

        <div class="p-5">
          <!-- Estado del pedido -->
          <div class="mb-6">
            <h3 class="font-semibold text-slate-700 mb-4">Estado del Pedido</h3>
            <div class="flex items-center">
              <ng-container
                *ngFor="let step of order.timelineSteps; let i = index"
              >
                <div class="flex flex-col items-center">
                  <div
                    class="flex items-center justify-center w-10 h-10 rounded-full"
                    [ngClass]="{

          'bg-green-500 text-white':
            getStepStatus(order.statusName, step.name, order.timelineSteps) === 'completed',
          'bg-blue-600 text-white animate-pulse':
            getStepStatus(order.statusName, step.name, order.timelineSteps) === 'current',
          'bg-slate-200 text-slate-500':
            getStepStatus(order.statusName, step.name, order.timelineSteps) === 'upcoming'
        }"
                  >
                    <i [class]="getStepIcon(step.name)"></i>
                  </div>
                  <p
                    class="text-xs mt-2 text-center"
                    [ngClass]="{
                      'font-bold text-blue-700':
                        getStepStatus(
                          order.statusName,
                          step.name,
                          order.timelineSteps
                        ) === 'current',
                      'text-slate-600':
                        getStepStatus(
                          order.statusName,
                          step.name,
                          order.timelineSteps
                        ) !== 'current'
                    }"
                  >
                    {{ step.name }}
                  </p>
                </div>
                <div
                  *ngIf="i < order.timelineSteps.length - 1"
                  class="flex-auto border-t-2 mx-2"
                  [ngClass]="{
                    'border-green-500':
                      getStepStatus(
                        order.statusName,
                        step.name,
                        order.timelineSteps
                      ) === 'completed',
                    'border-slate-200':
                      getStepStatus(
                        order.statusName,
                        step.name,
                        order.timelineSteps
                      ) !== 'completed'
                  }"
                ></div>
              </ng-container>
            </div>

            <!-- Tiempo estimado -->
            <div
              *ngIf="order.estimatedTime"
              class="mt-2 text-sm text-slate-500 flex flex-col"
            >
              <span
                >Tiempo total estimado de entrega:
                {{ order.estimatedTime }} mins</span
              >
              <span>
                Tiempo de viaje: {{ order.estimatedDuration }} (Distancia:
                {{ order.estimatedDistance }})
              </span>
            </div>
          </div>

          <!-- Productos y lugar de entrega -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
            <!-- Resumen de productos -->
            <div>
              <h4 class="font-semibold text-slate-700 mb-3">
                Productos ({{ order.details.length }})
              </h4>
              <ul class="text-sm text-slate-600 space-y-1">
                <li *ngFor="let item of order.details">
                  {{ item.productName }} x{{ item.quantity }} - S/{{
                    item.unitPrice * item.quantity | number : "1.2-2"
                  }}
                </li>
              </ul>

              <!-- Mini avatar de productos -->
              <div class="flex -space-x-3 mt-3">
                <img
                  *ngFor="let item of order.details | slice : 0 : 4"
                  [src]="'https://picsum.photos/seed/' + item.productId + '/64'"
                  [alt]="item.productName"
                  class="w-12 h-12 rounded-full object-cover border-2 border-white"
                  pTooltip="{{ item.productName }} x{{ item.quantity }}"
                  tooltipPosition="top"
                />
                <div
                  *ngIf="order.details.length > 4"
                  class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-semibold border-2 border-white"
                >
                  +{{ order.details.length - 4 }}
                </div>
              </div>
            </div>

            <!-- Lugar de entrega y mapa -->
            <div *ngIf="order.deliveryStreet">
              <h4 class="font-semibold text-slate-700 mb-3">
                Lugar de Entrega
              </h4>
              <a
                [href]="
                  'https://www.google.com/maps?q=' +
                  order.deliveryLatitude +
                  ',' +
                  order.deliveryLongitude
                "
                target="_blank"
                class="block rounded-xl overflow-hidden group border hover:border-blue-500 transition-all duration-300"
              >
                <img
                  class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-300"
                  [src]="
                    'https://maps.googleapis.com/maps/api/staticmap?center=' +
                    order.deliveryLatitude +
                    ',' +
                    order.deliveryLongitude +
                    '&zoom=16&size=600x300&maptype=roadmap&markers=color:0xff5733%7C' +
                    order.deliveryLatitude +
                    ',' +
                    order.deliveryLongitude +
                    '&key=' +
                    googleMapsApiKey
                  "
                  alt="Mapa de la ubicación de entrega"
                />
              </a>
              <div class="mt-3 text-sm">
                <p class="font-medium text-slate-800">
                  {{ order.deliveryStreet }}
                </p>
                <p class="text-slate-500">{{ order.deliveryReference }}</p>
              </div>

              <div
                *ngIf="order.currentLatitude && order.currentLongitude"
                class="mt-3"
              >
                <h4 class="font-semibold text-slate-700 mb-2">
                  Ubicación actual del delivery
                </h4>
                <a
                  [href]="
                    'https://www.google.com/maps?q=' +
                    order.currentLatitude +
                    ',' +
                    order.currentLongitude
                  "
                  target="_blank"
                  class="block rounded-xl overflow-hidden group border hover:border-blue-500 transition-all duration-300"
                >
                  <img
                    class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-300"
                    [src]="
                      'https://maps.googleapis.com/maps/api/staticmap?center=' +
                      order.currentLatitude +
                      ',' +
                      order.currentLongitude +
                      '&zoom=16&size=600x300&maptype=roadmap&markers=color:0x007bff%7C' +
                      order.currentLatitude +
                      ',' +
                      order.currentLongitude +
                      '&key=' +
                      googleMapsApiKey
                    "
                    alt="Ubicación actual del delivery"
                  />
                </a>
              </div>
            </div>
          </div>
        </div>

        <div
          *ngIf="order.statusName === 'Completada'"
          class="p-5 border-t border-slate-200 bg-slate-50 rounded-b-2xl"
        >
          <h4 class="font-semibold text-slate-800 mb-4">
            ¿Qué te pareció tu pedido?
          </h4>
          <div class="space-y-3">
            <div
              class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm"
            >
              <span class="font-medium text-slate-700"
                >Servicio y Entrega (Pedido #{{ order.id }})</span
              >
              <p-button
                label="Calificar"
                icon="pi pi-star"
                styleClass="p-button-outlined p-button-sm"
                (onClick)="
                  openReviewModal(
                    order.id,
                    'order',
                    'Servicio y Entrega (Pedido #' + order.id + ')'
                  )
                "
              ></p-button>
            </div>

            <h5 class="font-semibold text-slate-700 pt-2">Productos:</h5>
            <div
              *ngFor="let item of order.details"
              class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm"
            >
              <span class="text-slate-700">{{ item.productName }}</span>
              <p-button
                label="Calificar"
                icon="pi pi-star-fill"
                styleClass="p-button-outlined p-button-sm p-button-warning"
                (onClick)="
                  openReviewModal(item.productId, 'product', item.productName)
                "
              ></p-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-review-modal
  [(display)]="displayReviewModal"
  [resourceId]="reviewResourceId"
  [resourceType]="reviewResourceType"
  [resourceName]="reviewResourceName"
  (reviewSubmitted)="onReviewModalClosed()"
></app-review-modal>
