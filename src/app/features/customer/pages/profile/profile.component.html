<div *ngIf="profileForm" class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6">
  <h2
    class="text-2xl sm:text-3xl font-bold text-gray-800 text-center sm:text-left"
  >
    Mi Perfil
  </h2>

  <div
    class="bg-white rounded-xl shadow-md hover:shadow-lg p-4 sm:p-6 grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 transition-shadow duration-300"
  >
    <div class="flex flex-col items-center md:col-span-1 mb-6 md:mb-0">
      <div
        class="relative w-28 h-28 sm:w-32 sm:h-32 md:w-36 md:h-36 rounded-full overflow-hidden border-4 border-gray-300 flex justify-center items-center cursor-pointer"
        [ngClass]="{
          'border-blue-500': isEditing,
          'border-dashed border-blue-400': isDragging && isEditing
        }"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="isEditing ? fileInput.click() : null"
      >
        <img
          [src]="avatarPreview || user?.profileImageUrl || 'default-avatar.jpg'"
          alt="Avatar"
          class="w-full h-full object-cover rounded-full"
        />

        <div
          *ngIf="isDragging && isEditing"
          class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-40 text-white text-center"
        >
          <i class="pi pi-upload text-2xl sm:text-3xl mb-1 sm:mb-2"></i>
          <span class="text-xs sm:text-sm">Suelta para subir</span>
        </div>

        <div
          *ngIf="isEditing && !isDragging"
          class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-20 text-white text-center transition-opacity duration-200 hover:bg-opacity-40"
        >
          <i class="pi pi-camera text-3xl sm:text-4xl"></i>
          <span class="mt-1 text-xs sm:text-sm"
            >Clic o arrastra para cambiar</span
          >
        </div>

        <input
          type="file"
          #fileInput
          class="hidden"
          accept="image/*"
          (change)="onFileSelected($event)"
        />
      </div>

      <h3
        class="mt-3 text-lg sm:text-xl font-semibold text-gray-700 text-center"
      >
        {{ user?.fullName }}
      </h3>
      <p class="text-gray-500 text-sm sm:text-base text-center">
        {{ user?.username }}
      </p>
    </div>

    <!-- Formulario -->
    <div class="md:col-span-2 space-y-4 sm:space-y-5">
      <form
        [formGroup]="profileForm"
        class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"
      >
        <!-- Nombres -->
        <div>
          <label class="block text-gray-600 font-medium mb-1">Nombres</label>
          <input
            pInputText
            type="text"
            formControlName="firstName"
            class="w-full border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 p-2"
          />
          <div
            *ngIf="
              profileForm.get('firstName')?.invalid &&
              profileForm.get('firstName')?.touched
            "
            class="text-sm text-red-500 mt-1"
          >
            <div *ngIf="profileForm.get('firstName')?.errors?.['required']">
              El nombre es obligatorio.
            </div>
          </div>
        </div>

        <!-- Apellidos -->
        <div>
          <label class="block text-gray-600 font-medium mb-1">Apellidos</label>
          <input
            pInputText
            type="text"
            formControlName="lastName"
            class="w-full border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 p-2"
          />
          <div
            *ngIf="
              profileForm.get('lastName')?.invalid &&
              profileForm.get('lastName')?.touched
            "
            class="text-sm text-red-500 mt-1"
          >
            <div *ngIf="profileForm.get('lastName')?.errors?.['required']">
              El apellido es obligatorio.
            </div>
          </div>
        </div>

        <!-- Email -->
        <div class="sm:col-span-2">
          <label class="block text-gray-600 font-medium mb-1">Email</label>
          <input
            pInputText
            type="email"
            formControlName="email"
            class="w-full border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 p-2"
          />
          <div
            *ngIf="
              profileForm.get('email')?.invalid &&
              profileForm.get('email')?.touched
            "
            class="text-sm text-red-500 mt-1"
          >
            <div *ngIf="profileForm.get('email')?.errors?.['required']">
              El email es obligatorio.
            </div>
            <div *ngIf="profileForm.get('email')?.errors?.['email']">
              Email no válido.
            </div>
          </div>
          <div
            *ngIf="emailDaysLeft && emailDaysLeft > 0"
            class="text-sm text-red-500 mt-1"
          >
            Solo puedes cambiar tu email nuevamente en {{ emailDaysLeft }} días.
          </div>
        </div>

        <!-- Teléfono -->
        <div class="sm:col-span-2">
          <label class="block text-gray-600 font-medium mb-1">Teléfono</label>
          <input
            pInputText
            type="text"
            formControlName="phone"
            class="w-full border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 p-2"
          />
          <div
            *ngIf="
              profileForm.get('phone')?.invalid &&
              profileForm.get('phone')?.touched
            "
            class="text-sm text-red-500 mt-1"
          >
            <div *ngIf="profileForm.get('phone')?.errors?.['required']">
              El teléfono es obligatorio.
            </div>
            <div *ngIf="profileForm.get('phone')?.errors?.['pattern']">
              Solo se permiten números.
            </div>
            <div *ngIf="profileForm.get('phone')?.errors?.['minlength']">
              El teléfono debe tener 9 dígitos.
            </div>
            <div *ngIf="profileForm.get('phone')?.errors?.['maxlength']">
              El teléfono debe tener 9 dígitos.
            </div>
          </div>
        </div>

        <!-- Username -->
        <div class="sm:col-span-2">
          <label class="block text-gray-600 font-medium mb-1">Usuario</label>
          <input
            pInputText
            type="text"
            formControlName="username"
            class="w-full border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 p-2"
          />
          <div
            *ngIf="
              profileForm.get('username')?.invalid &&
              profileForm.get('username')?.touched
            "
            class="text-sm text-red-500 mt-1"
          >
            <div *ngIf="profileForm.get('username')?.errors?.['required']">
              El username es obligatorio.
            </div>
            <div *ngIf="profileForm.get('username')?.errors?.['minlength']">
              Mínimo 3 caracteres.
            </div>
          </div>
          <div
            *ngIf="usernameDaysLeft && usernameDaysLeft > 0"
            class="text-sm text-red-500 mt-1"
          >
            Solo puedes cambiar tu username nuevamente en
            {{ usernameDaysLeft }} días.
          </div>
        </div>

        <div
          *ngIf="isEditing && user?.provider !== 'LOCAL' && !user?.hasPassword"
          class="sm:col-span-2"
        >
          <label class="block text-gray-600 font-medium mb-1"
            >Nueva Contraseña</label
          >
          <input
            pInputText
            type="password"
            formControlName="newPassword"
            class="w-full border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 p-2"
          />
          <div
            *ngIf="
              profileForm.get('newPassword')?.invalid &&
              profileForm.get('newPassword')?.touched
            "
            class="text-sm text-red-500 mt-1"
          >
            <div *ngIf="profileForm.get('newPassword')?.errors?.['required']">
              La contraseña es obligatoria.
            </div>
            <div *ngIf="profileForm.get('newPassword')?.errors?.['minlength']">
              Mínimo 6 caracteres.
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Botones Editar/Guardar -->
  <div
    class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 mt-4"
  >
    <button
      pButton
      label="{{ isEditing ? 'Cancelar' : 'Editar' }}"
      class="p-button-outlined w-full sm:w-auto"
      (click)="toggleEdit()"
    ></button>
    <button
      *ngIf="isEditing"
      pButton
      label="Guardar"
      class="p-button-primary w-full sm:w-auto"
      (click)="saveChanges()"
    ></button>
  </div>
</div>
